{% extends "layouts/base.html" %}

{% block title %}{{ super() }} - {{ title }}{% endblock %}

{% block content %}
<div class="absolute -top-96">
    <label for="barcode-scanner-input">Barcode Scanner Input</label>
    <input type="text" id="barcode-scanner-input" autocomplete="off">
</div>

<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-sky-700">{{ title }}</h1>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category_flash, message in messages %}
            <div class="p-4 mb-4 text-sm rounded-lg
                        {% if category_flash == 'error' %}bg-red-100 text-red-700 border border-red-300
                        {% elif category_flash == 'success' %}bg-green-100 text-green-700 border border-green-300
                        {% else %}bg-blue-100 text-blue-700 border border-blue-300{% endif %}" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="md:col-span-1 bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-xl font-semibold mb-4 text-slate-700">Add Item to Sale</h2>
        <div id="addItemForm" class="space-y-4">
            <div>
                <label for="product_select" class="block text-sm font-medium text-slate-700">Product</label>
                <select id="product_select" name="product_select" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                    <option value="">-- Select Product --</option>
                    {% for product_item in products %}
                        {% if product_item.StockQuantity > 0 %}
                            <option value="{{ product_item.ProductID }}" data-price="{{ product_item.Price }}" data-name="{{ product_item.ProductName }}" data-stock="{{ product_item.StockQuantity }}">
                                {{ product_item.ProductName }} (Stock: {{ product_item.StockQuantity }})
                            </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="quantity" class="block text-sm font-medium text-slate-700">Quantity</label>
                <input type="number" id="quantity" name="quantity" min="1" value="1" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
            </div>
            <button type="button" id="addToCartBtn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded shadow transition-colors">
                Add to Cart
            </button>
        </div>
    </div>

    <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-xl font-semibold mb-4 text-slate-700">Current Sale Items</h2>
        <div id="cartItems" class="mb-4 space-y-2 min-h-[100px]">
            <p class="text-slate-500 italic">No items in cart yet.</p>
        </div>
        <div class="border-t border-slate-300 pt-4">
            <p class="text-lg font-semibold text-right">Total: <span id="cartTotal" class="text-sky-600">$0.00</span></p>
        </div>

        <form id="finalizeSaleForm" method="POST" action="{{ url_for('main.new_sale_route') }}" class="mt-6 space-y-4">
            <input type="hidden" name="cart_data" id="cart_data_input">
            <div>
                <label for="customer_select" class="block text-sm font-medium text-slate-700">Customer (Optional)</label>
                <select id="customer_select" name="customer_id" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                    <option value="">-- Guest Sale --</option>
                    {% for customer_item in customers %}
                        <option value="{{ customer_item.CustomerID }}">
                            {{ customer_item.FirstName }} {{ customer_item.LastName or '' }} ({{ customer_item.Email or 'ID: ' ~ customer_item.CustomerID }})
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="payment_method" class="block text-sm font-medium text-slate-700">Payment Method</label>
                <select id="payment_method" name="payment_method" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                    <option value="Cash">Cash</option>
                    <option value="Card">Card</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <button type="submit" id="finalizeSaleBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded shadow transition-colors">
                Finalize Sale
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addToCartBtn = document.getElementById('addToCartBtn');
    const productSelect = document.getElementById('product_select');
    const quantityInput = document.getElementById('quantity');
    const cartItemsDiv = document.getElementById('cartItems');
    const cartTotalSpan = document.getElementById('cartTotal');
    const cartDataInput = document.getElementById('cart_data_input');
    const finalizeSaleForm = document.getElementById('finalizeSaleForm');
    const barcodeInput = document.getElementById('barcode-scanner-input');
    const WEBSOCKET_PORT = 5678; // Ensure this matches your Python server's WebSocket port

    let cart = [];

    function renderCart() {
        cartItemsDiv.innerHTML = '';
        let currentTotal = 0;
        if (cart.length === 0) {
            cartItemsDiv.innerHTML = '<p class="text-slate-500 italic">No items in cart yet.</p>';
        } else {
            const table = document.createElement('table');
            table.className = 'min-w-full text-sm';
            const tbody = document.createElement('tbody');
            cart.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-slate-200';
                tr.innerHTML = `
                    <td class="py-2 pr-2">${item.productName}</td>
                    <td class="py-2 px-2 text-center">
                        <button type="button" class="font-bold text-lg text-slate-500 hover:text-black w-6 h-6 leading-6" data-action="decrement" data-index="${index}">-</button>
                        <span class="mx-2">${item.quantity}</span>
                        <button type="button" class="font-bold text-lg text-slate-500 hover:text-black w-6 h-6 leading-6" data-action="increment" data-index="${index}">+</button>
                    </td>
                    <td class="py-2 px-2 text-right">$${item.unitPrice.toFixed(2)}</td>
                    <td class="py-2 pl-2 text-right font-semibold">$${item.lineTotal.toFixed(2)}</td>
                    <td class="py-2 pl-2 text-right">
                        <button type="button" class="text-red-500 hover:text-red-700 text-lg font-bold remove-item-btn p-1" data-action="remove" data-index="${index}" title="Remove Item">&times;</button>
                    </td>
                `;
                tbody.appendChild(tr);
                currentTotal += item.lineTotal;
            });
            table.appendChild(tbody);
            cartItemsDiv.appendChild(table);
        }
        cartTotalSpan.textContent = `$${currentTotal.toFixed(2)}`;
    }

    function addItemToCart(productData, quantity) {
        const existingItemIndex = cart.findIndex(item => item.productId === productData.productId);
        let currentQuantityInCart = existingItemIndex > -1 ? cart[existingItemIndex].quantity : 0;

        if (quantity + currentQuantityInCart > productData.maxStock) {
            showToast(`Not enough stock for ${productData.productName}. Requested: ${quantity + currentQuantityInCart}, Available: ${productData.maxStock}`, 'error');
            return false;
        }

        if (existingItemIndex > -1) {
            cart[existingItemIndex].quantity += quantity;
            cart[existingItemIndex].lineTotal = cart[existingItemIndex].quantity * cart[existingItemIndex].unitPrice;
        } else {
            cart.push({
                productId: productData.productId,
                productName: productData.productName,
                quantity: quantity,
                unitPrice: productData.unitPrice,
                lineTotal: quantity * productData.unitPrice,
                maxStock: productData.maxStock
            });
        }
        renderCart();
        return true;
    }

    function updateQuantity(index, change) {
        const item = cart[index];
        if (!item) return;

        if (change > 0 && item.quantity + change > item.maxStock) {
            showToast(`Not enough stock for ${item.productName}.`, 'error');
            return;
        }

        item.quantity += change;

        if (item.quantity <= 0) {
            cart.splice(index, 1);
        } else {
            item.lineTotal = item.quantity * item.unitPrice;
        }
        renderCart();
    }

    function fetchProductAndAddToCart(barcode) {
         fetch(`/api/products/by_barcode/${barcode}`)
            .then(response => {
                if (response.ok) return response.json();
                showToast(`Barcode not found: ${barcode}`, 'error');
                throw new Error('Not found');
            })
            .then(product => {
                const added = addItemToCart({
                    productId: product.ProductID,
                    productName: product.ProductName,
                    unitPrice: product.Price,
                    maxStock: product.StockQuantity
                }, 1);
                if(added) {
                     showToast(`${product.ProductName} added to cart.`, 'success');
                }
            })
            .catch(error => {
                if (error.message !== 'Not found') {
                    console.error("Error processing barcode:", error);
                }
            });
    }

    // --- WebSocket Connection ---
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsHost = window.location.hostname;
    const wsPort = window.location.port || (wsProtocol === 'wss:' ? '443' : '80');
    const wsUri = `${wsProtocol}//${wsHost}:${wsPort}/ws/barcode`;
    let ws;

    function connectWebSocket() {
        console.log(`Connecting to WebSocket: ${wsUri}`);
        ws = new WebSocket(wsUri);

        ws.onopen = () => { console.log("WebSocket connected."); showToast("Scanner active.", "success"); };
        ws.onmessage = (event) => {
            try {
                const message = JSON.parse(event.data);
                if (message.type === "barcode" && message.data) {
                    fetchProductAndAddToCart(message.data);
                }
            } catch (e) { console.error("WebSocket message parse error:", e); }
        };
        ws.onclose = () => { console.log("WebSocket closed. Reconnecting..."); showToast("Scanner disconnected. Retrying...", "error"); setTimeout(connectWebSocket, 5000); };
        ws.onerror = (err) => { console.error("WebSocket error:", err); ws.close(); }; // Close on error to trigger reconnect via onclose
    }

    // --- Barcode Input Listener (for standard USB scanners/manual input) ---
    barcodeInput.addEventListener('input', function(e) {
        if (e.target.value.includes('\n')) {
             const manualBarcode = e.target.value.replace('\n', '').trim();
             if (manualBarcode) {
                fetchProductAndAddToCart(manualBarcode);
             }
             e.target.value = '';
        }
    });

    // --- Smart Refocus for Barcode Input ---
     document.body.addEventListener('click', function(e) {
        // Only refocus if the click is not on an interactive element
        const interactiveElements = ['INPUT', 'SELECT', 'BUTTON', 'A', 'TEXTAREA'];
        if (!interactiveElements.includes(e.target.tagName) && !e.target.closest('button, a')) {
            barcodeInput.focus();
        }
    });

    // --- Event Listeners ---
    addToCartBtn.addEventListener('click', function() {
        const selected = productSelect.options[productSelect.selectedIndex];
        if (!selected.value) { alert("Please select a product."); return; }
        addItemToCart({
            productId: parseInt(selected.value),
            productName: selected.dataset.name,
            unitPrice: parseFloat(selected.dataset.price),
            maxStock: parseInt(selected.dataset.stock)
        }, parseInt(quantityInput.value));
        barcodeInput.focus(); // Refocus after manual add
    });

    cartItemsDiv.addEventListener('click', function(event) {
        const button = event.target.closest('button');
        if (!button) return;
        const action = button.dataset.action;
        const index = parseInt(button.dataset.index);

        if (action === 'remove') { cart.splice(index, 1); renderCart(); }
        else if (action === 'increment') { updateQuantity(index, 1); }
        else if (action === 'decrement') { updateQuantity(index, -1); }
        barcodeInput.focus(); // Refocus after cart interaction
    });

    finalizeSaleForm.addEventListener('submit', function(event) {
        if (cart.length === 0) { alert("Cannot finalize sale: Cart is empty."); event.preventDefault(); return; }
        const cartDataForSubmission = cart.map(item => ({ product_id: item.productId, quantity: item.quantity, unit_price: item.unitPrice }));
        cartDataInput.value = JSON.stringify(cartDataForSubmission);
    });

    // --- Initialize ---
    renderCart();
    connectWebSocket();
    barcodeInput.focus(); // Initial focus

});
</script>
{% endblock %}