{% extends "layouts/base.html" %}

{% block title %}{{ super() }} - {{ title }}{% endblock %}

{% block content %}
<div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg">
    <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-sky-700">Welcome, {{ session['username'] }}!</h1>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category_flash, message in messages %}
                <div class="p-4 mb-4 text-sm rounded-lg 
                            {% if category_flash == 'error' %}bg-red-100 text-red-700 border border-red-300
                            {% elif category_flash == 'success' %}bg-green-100 text-green-700 border border-green-300
                            {% else %}bg-blue-100 text-blue-700 border border-blue-300{% endif %}" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if session['role'] == 'admin' %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8">
        <div class="bg-sky-500 text-white p-4 sm:p-6 rounded-lg shadow-md">
            <div class="text-3xl sm:text-4xl font-bold">{{ stats.total_products if stats.total_products is not none else 'N/A' }}</div>
            <div class="text-sm sm:text-base opacity-90">Total Products</div>
            <a href="{{ url_for('main.show_products') }}" class="text-xs sm:text-sm mt-2 hover:underline self-start">View &rarr;</a>
        </div>
        <div class="bg-teal-500 text-white p-4 sm:p-6 rounded-lg shadow-md">
            <div class="text-3xl sm:text-4xl font-bold">{{ stats.total_categories if stats.total_categories is not none else 'N/A' }}</div>
            <div class="text-sm sm:text-base opacity-90">Total Categories</div>
            <a href="{{ url_for('main.show_categories') }}" class="text-xs sm:text-sm mt-2 hover:underline self-start">View &rarr;</a>
        </div>
        <div class="bg-amber-500 text-white p-4 sm:p-6 rounded-lg shadow-md">
            <div class="text-3xl sm:text-4xl font-bold">{{ stats.total_customers if stats.total_customers is not none else 'N/A' }}</div>
            <div class="text-sm sm:text-base opacity-90">Total Customers</div>
            <a href="{{ url_for('main.show_customers') }}" class="text-xs sm:text-sm mt-2 hover:underline self-start">View &rarr;</a>
        </div>
        <div class="bg-red-500 text-white p-4 sm:p-6 rounded-lg shadow-md">
            <div class="text-3xl sm:text-4xl font-bold">{{ stats.low_stock_items if stats.low_stock_items is not none else 'N/A' }}</div>
            <div class="text-sm sm:text-base opacity-90">Low Stock Items</div>
            <a href="{{ url_for('main.low_stock_report_route') }}" class="text-xs sm:text-sm mt-2 hover:underline self-start">View &rarr;</a>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
        <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-slate-700 mb-4">Sales in the Last 7 Days</h2>
            <canvas id="salesChart"></canvas>
        </div>

        <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-slate-700 mb-4">Revenue by Category</h2>
            <canvas id="categorySalesChart"></canvas>
        </div>

        <div class="bg-white p-4 rounded-lg shadow lg:col-span-2">
            <h2 class="text-xl font-semibold text-slate-700 mb-4">Top 5 Best-Selling Products (by Quantity)</h2>
            <canvas id="bestSellersChart"></canvas>
        </div>
    </div>
    {% else %}
        <p class="text-lg">Use the sidebar to navigate the application.</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // CORRECTED LINE: Ensured |safe filter is applied
    if ({{ (session['role'] == 'admin')|tojson|safe }}) {
        // --- Chart 1: Sales in Last 7 Days ---
        fetch("{{ url_for('main.sales_last_7_days_api') }}")
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('salesChart').getContext('2d');
                if (!ctx) return; // Add check if element exists
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Total Sales ($)',
                            data: data.data,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            })
            .catch(error => console.error("Error fetching sales data:", error)); // Add error handling

        // --- Chart 2: Sales by Category ---
        fetch("{{ url_for('main.sales_by_category_api') }}")
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('categorySalesChart').getContext('2d');
                 if (!ctx) return; // Add check if element exists
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Revenue',
                            data: data.data,
                            backgroundColor: [
                                'rgba(0, 0, 0, 0.7)', 'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'
                                // Add more colors if you expect more categories
                            ],
                        }]
                    },
                    options: { responsive: true }
                });
            })
             .catch(error => console.error("Error fetching category sales data:", error)); // Add error handling

        // --- Chart 3: Best Selling Products ---
        fetch("{{ url_for('main.best_sellers_api') }}")
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('bestSellersChart').getContext('2d');
                 if (!ctx) return; // Add check if element exists
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Total Quantity Sold',
                            data: data.data,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, indexAxis: 'y' } // Horizontal bar chart
                });
            })
             .catch(error => console.error("Error fetching best sellers data:", error)); // Add error handling
    }
});
</script>
{% endblock %}